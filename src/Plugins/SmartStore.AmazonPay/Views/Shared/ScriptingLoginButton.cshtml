@using SmartStore.AmazonPay.Services;
@model SmartStore.AmazonPay.Models.AmazonPayViewModel

<script type="text/javascript">
	window.onAmazonLoginReady = function() {
		try {
			amazon.Login.setClientId('@Html.Raw(Model.ClientId)');
		}
		catch (e) {
			console.log(e);
			alert(e);
		}
	};

	window.onAmazonPaymentsReady = function () {
		try {
			// We cannot provide a logout link.
			//amazon.Login.logout();
		}
		catch (e) {
			console.log(e);
			alert(e);
		}

		try {
			var isAuthentication = @((Model.Type == AmazonPayRequestType.AuthenticationPublicInfo).ToString().ToLower());
			var handlerUrl = '@Html.Raw(string.Concat(Model.ButtonHandlerUrl, Model.ButtonHandlerUrl.Contains('?') ? "&" : "?"))';
			var accessToken, scope = 'profile';

			if (!isAuthentication) {
				scope += ' payments:widget payments:shipping_address payments:billing_address';
			}

			OffAmazonPayments.Button(isAuthentication ? 'amazon-pay-auth-button' : 'amazon-pay-login-button', '@Html.Raw(Model.SellerId)', {
				type: '@(Model.ButtonType ?? (Model.Type == AmazonPayRequestType.AuthenticationPublicInfo ? "Login" : "PwA"))',
				color: '@(Model.ButtonColor ?? "Gold")',
				size:  '@(Model.ButtonSize ?? "small")',
				language: '@(Model.LanguageCode ?? "de-DE")',
				authorization: function() {
					amazon.Login.authorize({
							scope: scope,
							popup: @(Model.UsePopupDialog.ToString().ToLower()),
						},
						function (authorizeResponse) {
							accessToken = authorizeResponse.access_token;

							if (isAuthentication) {
								handlerUrl += 'accessToken=' + encodeURIComponent(accessToken);
								window.location = handlerUrl;
							}
						}
					);
				},
				onSignIn: function (orderReference) {
					if (!isAuthentication) {
						var referenceId = orderReference.getAmazonOrderReferenceId();
						if (referenceId) {
							handlerUrl += 'orderReferenceId=' + encodeURIComponent(referenceId);
							handlerUrl += '&accessToken=' + encodeURIComponent(accessToken);
							window.location = handlerUrl;
						}
						else {
							displayNotification('@T("Plugins.Payments.AmazonPay.MissingOrderReferenceId")', 'error');
						}
					}
				},
				onError: function (error) {
					alert(error.getErrorCode() + ': ' + error.getErrorMessage());
				}
			});
		}
		catch (e) {
			console.log(e);
			alert(e);
		}
	};
</script>

<script async="async" src="@Html.Raw(Model.WidgetUrl)"></script>
